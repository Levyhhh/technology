# 分布式事务协议

1. **两阶段提交协议（2PC）**
    - **原理**：
        - 第一阶段是准备阶段，协调者向所有参与者发送事务内容，询问是否可以提交事务。参与者执行事务操作并记录日志，但不提交事务，然后将操作结果反馈给协调者。
        - 第二阶段是提交阶段，如果所有参与者都反馈可以提交，协调者就向所有参与者发送提交指令，参与者提交事务；否则，协调者向所有参与者发送回滚指令，参与者回滚事务。
    - **应用场景**：
        - 适用于对数据一致性要求极高的场景，如金融转账系统。例如，在银行系统中从账户A转账到账户B，涉及两个数据库操作（A账户扣款和B账户收款），2PC可以保证这两个操作要么都成功，要么都失败，从而保证账户余额的一致性。
    - **优缺点**：
        - **优点**：实现了强一致性，能够保证事务的原子性。在简单的分布式环境下，能够有效地协调多个参与者完成事务。
        - **缺点**：存在单点故障问题，若协调者故障，可能导致参与者长时间等待而阻塞。性能较差，因为在准备阶段需要等待所有参与者响应，且整个过程是同步的，会降低系统的吞吐量。
2. **三阶段提交协议（3PC）**
    - **原理**：
        - 第一阶段是询问阶段，协调者询问参与者是否可以提交事务。
        - 第二阶段是预提交阶段，参与者如果可以提交就进行预提交（如锁定资源等）并反馈给协调者。
        - 第三阶段是提交阶段，协调者根据参与者的反馈决定是提交还是回滚。
    - **应用场景**：
        - 同样适用于需要保证数据一致性的分布式系统，相较于2PC，它对协调者故障有一定的容错能力。例如，在分布式数据库系统的集群环境中，当进行跨库事务操作时，3PC可以在一定程度上减少协调者故障导致的事务阻塞风险。
    - **优缺点**：
        - **优点**：降低了协调者单点故障导致的阻塞风险，通过预提交阶段使得参与者状态更加明确，在一定程度上提高了系统的可靠性。
        - **缺点**：实现复杂，性能开销较大。并且仍然不能完全避免数据不一致的情况，如在网络分区等极端情况下，可能会出现部分节点提交而部分节点回滚的现象。
3. **补偿事务（TCC - Try - Confirm - Cancel）**
    - **原理**：
        - Try阶段：主要是对业务系统进行检查并预留资源。例如，在电商系统的下单业务中，这个阶段会检查商品库存是否足够，冻结相应的库存，同时检查用户账户余额是否足够，冻结相应的支付金额，但不进行实际的扣库存和支付操作。
        - Confirm阶段：确认执行业务操作，是真正完成业务逻辑的阶段。如在上述例子中，确认扣减库存和完成支付，并且将订单状态设置为已完成。
        - Cancel阶段：取消操作，用于回滚事务。如果在Try阶段之后，业务无法继续执行（如用户取消订单），则在这个阶段释放冻结的库存和支付金额，将业务状态恢复到初始状态。
    - **应用场景**：
        - 适用于对性能要求较高，且业务能够被拆分成三个明确阶段的分布式场景。例如，微服务架构下的电商系统、分布式交易系统等，它可以有效地处理跨服务的事务问题。
    - **优缺点**：
        - **优点**：相对于2PC和3PC，TCC的性能较好，因为它不需要长时间的等待和全局的锁。它将事务的控制逻辑放在业务层，能够更好地适应复杂多变的业务场景。
        - **缺点**：对业务的侵入性较强，需要业务系统自己实现Try、Confirm和Cancel三个逻辑，开发成本较高。并且如果在Confirm或Cancel阶段出现问题，可能会导致数据不一致，需要有相应的补偿机制来解决。
4. **本地消息表（Event Sourcing）**
    - **原理**：
        - 事务发起方在本地事务中记录消息日志（本地消息表），消息状态为“待发送”。然后执行本地业务操作，若本地事务成功，消息表中就会留下待发送的消息记录。
        - 有一个专门的消息发送服务，它会定期扫描本地消息表，将状态为“待发送”的消息发送给事务参与方。
        - 参与方收到消息后，执行相应的业务操作，并返回操作结果。如果操作成功，消息发送方将本地消息表中的消息状态更新为“已发送”；如果操作失败，消息发送方可以根据策略进行重试或者标记消息为“发送失败”，然后进行人工干预等处理。
    - **应用场景**：
        - 适用于跨系统的异步事务处理，特别是在微服务架构下，服务之间的通信和事务协调。例如，在一个电商系统中，订单服务和库存服务是两个不同的微服务，通过本地消息表可以异步地协调订单创建和库存扣减的事务。
    - **优缺点**：
        - **优点**：实现了最终一致性，对业务系统的侵入性相对较小，并且可以通过消息队列等方式实现异步处理，提高系统的整体性能和吞吐量。
        - **缺点**：系统的复杂性增加，需要维护消息表以及消息发送和处理的机制。并且消息可能会出现延迟发送、丢失等情况，需要有完善的消息处理和补偿机制来保证事务的可靠性。
