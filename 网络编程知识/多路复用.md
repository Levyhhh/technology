# 多路复用

- **I/O多路复用器**：在计算机系统中，用于处理多个I/O操作，避免为每个I/O操作创建单独线程或进程的开销，提高系统的并发处理能力和资源利用率，主要包括select、poll和epoll。
  - **select**：最早于1983年出现在4.2BSD中。通过一个select()系统调用来监视多个文件描述符的数组。使用fd_set来表示文件描述符集合，它是一个位图结构，通过整型数组模拟而成，每个位对应一个文件描述符，用于表示该文件描述符是否处于就绪状态。当select()返回后，该数组中就绪的文件描述符便会被内核修改标志位，使得进程可以获得这些文件描述符从而进行后续的读写操作。几乎在所有的平台上都支持，具有良好的跨平台性。单个进程能够监视的文件描述符的数量存在最大限制，在Linux上一般为1024。select()所维护的存储大量文件描述符的数据结构，随着文件描述符数量的增大，其复制的开销也线性增长。同时，需要对所有文件描述符进行线性扫描，当监听的文件描述符数量较多时，效率会下降。
  - **poll**：1986年诞生于System V Release 3。和select在本质上没有太大差别，使用一个pollfd结构体数组来存储文件描述符及其关注的事件，没有最大文件描述符数量的限制。包含大量文件描述符的数组被整体复制于用户态和内核的地址空间之间，而不论这些文件描述符是否就绪，它的开销随着文件描述符数量的增加而线性增大。
  - **epoll**：直到Linux2.6才出现，由内核直接支持。引入了事件通知机制，通过epoll_ctl注册关注的事件，并通过epoll_wait阻塞等待事件的发生。支持水平触发和边缘触发两种工作模式。采用基于事件的就绪通知方式，事先通过epoll_ctl()来注册一个文件描述符，一旦基于某个文件描述符就绪时，内核会采用类似callback的回调机制，迅速激活这个文件描述符，当进程调用epoll_wait()时便得到通知。只告知那些就绪的文件描述符，而且当调用epoll_wait()获得就绪文件描述符时，返回的不是实际的描述符，而是一个代表就绪描述符数量的值，只需去epoll指定的一个数组中依次取得相应数量的文件描述符即可，使用了内存映射（mmap）技术，省掉了这些文件描述符在系统调用时复制的开销。
- **时分多路复用器**：按时间片轮流分配信道资源给不同的输入信号。原理是将时间划分为一个个固定长度的时间片，每个时间片依次分配给不同的输入信号，各路信号在自己的时间片内独占信道进行传输。在数字通信系统中应用广泛，如计算机网络中的时分复用技术，将传输线路的时间分成若干个时间片，不同的用户数据在不同的时间片内传输，从而实现多路数据在同一线路上的传输。可以实现对信道资源的有效利用，提高传输效率，适用于数字信号的传输，但对同步要求较高，如果同步出现问题，可能导致数据错位或丢失。
- **频分多路复用器**：将信道的可用频带划分为若干个互不重叠的频段，每个频段分配给一个输入信号进行传输。不同的输入信号在不同的频段上同时传输，接收端通过滤波器将不同频段的信号分离出来。常用于模拟通信系统，如广播电台、有线电视等。在广播中，不同的电台使用不同的频率范围进行广播，听众通过调谐收音机到相应的频率来接收不同电台的节目。能够实现多个信号在同一信道上的同时传输，适用于模拟信号，技术相对成熟，但需要精确的频率划分和滤波技术，以避免相邻频段之间的干扰，且信道的频带利用率有一定限制。
- **波分多路复用器**：主要应用于光纤通信领域，利用不同波长的光信号在同一根光纤中传输。将不同波长的光信号复合到一根光纤中进行传输，在接收端再通过波长分离器将不同波长的光信号分离出来。可以大大提高光纤的传输容量，一根光纤可以同时传输多个不同波长的光信号，每个波长对应一个独立的信道。随着通信业务的飞速发展，对光纤带宽的需求不断增加，波分多路复用技术成为实现高速、大容量光纤通信的关键技术之一。充分利用了光纤的宽带特性，增加了传输容量，但设备成本较高，对波长的精确控制和管理要求严格。
- **码分多路复用器**：每个用户使用一个唯一的码序列（扩频码）来对自己的数据进行编码，不同用户的数据在同一信道上同时传输，接收端通过相关检测来分离出不同用户的数据。基于码分多址（CDMA）技术，各用户的信号在时间和频率上是重叠的，但通过不同的码序列来区分。在移动通信中得到了广泛应用，如3G、4G通信系统。具有抗干扰能力强、保密性好、频谱利用率高等优点，多个用户可以在同一频段上同时通信，无需严格的频率划分和时间同步。但系统的复杂度较高，需要精确的码序列设计和同步技术，以保证不同用户之间的干扰最小化。

## 内核高效管理多路复用器的方式

- **使用高效的数据结构**
  - **epoll使用红黑树**：在内核中通过红黑树跟踪进程待检测的文件描述符，增删查操作时间复杂度一般为O(logn)，如通过epoll_ctl函数添加或删除socket时，能快速在树中找到相应位置进行操作，减少内核和用户空间数据拷贝和内存分配。
  - **poll使用链表**：采用链表管理文件描述符集合，相比select的固定长度位图，避免了文件描述符数量限制，可更灵活地管理大量文件描述符。
- **采用事件驱动的通知机制**
  - **epoll的就绪链表**：内核维护就绪链表记录就绪事件，当socket有事件发生，通过回调函数将其加入就绪事件列表。用户调用epoll_wait函数时，只返回有事件发生的文件描述符个数，无需轮询扫描整个socket集合。例如高并发场景下，只有发生事件的socket对应的文件描述符会被放入就绪链表，epoll_wait直接获取这些就绪的文件描述符进行处理。
  - **信号驱动的I/O（SIGIO）**：进程注册信号处理函数接收I/O事件通知，当文件描述符有可读或可写等事件发生，内核向进程发送相应信号，进程在信号处理函数中进行I/O操作，避免进程一直阻塞等待I/O事件，提高系统并发处理能力。
- **减少数据拷贝和系统调用开销**
  - **epoll的一次拷贝**：epoll注册文件描述符时，将其加入内核中的红黑树，仅在有事件发生时，才将就绪的文件描述符从内核空间复制到用户空间，相比select和poll每次都要将文件描述符集合在用户态和内核态之间来回拷贝，大大减少了数据拷贝开销。
  - **优化系统调用**：如epoll_wait系统调用在无事件发生时阻塞进程，直到有事件发生或超时，不像传统阻塞I/O频繁进行系统调用检查I/O状态，减少了不必要的系统调用次数，降低系统开销。
- **利用内核缓冲区和异步I/O机制**
  - **内核缓冲区**：内核为文件描述符对应的I/O操作分配缓冲区，数据先在缓冲区缓存。应用程序读操作时，内核直接从缓冲区读取数据，不必每次从硬件设备读取；写操作时，数据先写入缓冲区，由内核在合适时机将缓冲区数据写入硬件设备，减少I/O操作次数，提高I/O效率。
  - **异步I/O**：允许应用程序发起I/O操作后立即返回，继续执行其他任务，内核在后台完成I/O操作后，通过回调函数或信号通知应用程序，使得进程在进行I/O操作时不会被阻塞，提高系统并发处理能力。

## 多路复用器提高系统并发处理能力的方式

- **I/O多路复用技术方面**
  - **减少线程或进程开销**：传统阻塞式I/O模型中，每个I/O操作需独立线程或进程处理，并发量增大时会创建大量线程或进程，导致上下文切换开销和内存消耗剧增。而I/O多路复用技术允许单个进程或线程同时监视多个文件描述符的I/O事件，避免为每个连接创建线程或进程的开销，提高系统资源利用率和并发处理能力。例如Web服务器使用epoll多路复用技术，单进程可管理成千上万个连接。
  - **事件驱动的通知机制**：多路复用器采用事件驱动方式，当文件描述符有可读、可写或异常等事件发生时，内核通知应用程序，应用程序再处理相应I/O操作，避免无谓的空转等待。如select多路复用接口可监控文件描述符集合上的读、写、异常事件，进程调用select后阻塞，直到有文件描述符就绪，select返回后进程对就绪的文件描述符进行处理，不像传统阻塞I/O一直阻塞等待某个I/O操作完成而无法处理其他请求。
  - **内核高效管理**：以epoll为例，在内核中维护事件表，应用程序通过epoll_ctl注册感兴趣的文件描述符和事件，事件发生时，内核直接将就绪的事件通知应用程序，无需像select和poll那样每次将大量文件描述符集合从用户态复制到内核态，也无需应用程序遍历所有文件描述符检查哪些就绪，减少系统开销，提高并发处理效率。
- **时分多路复用方面**
  - **轮流分配时间片**：将时间划分为固定长度的时间片，按顺序轮流分配给不同的输入信号。每个信号在自己的时间片内独占信道进行传输，多个信号在不同时间片内交替使用同一信道，实现多路信号的并发传输。例如计算机网络中的时分复用技术，将传输线路的时间分成若干个时间片，不同用户数据在不同时间片内传输，在一条线路上实现多个用户数据的并发传输。
  - **提高信道利用率**：每个时间片都被充分利用来传输数据，不会出现信道长时间空闲等待某个信号传输的情况，使信道资源得到更充分利用，提高系统在单位时间内处理多个信号的能力，即提高并发处理能力。
- **频分多路复用方面**
  - **划分频段并发传输**：将信道的可用频带划分为若干个互不重叠的频段，每个频段分配给一个输入信号进行传输。多个信号在不同频段上同时传输，互不干扰，实现多路信号在同一信道上的并发传输。例如广播电台利用频分多路复用技术，不同电台使用不同频率范围进行广播，众多电台信号可在同一空间中同时传播，提高信息传输并发量。
  - **充分利用频带资源**：通过合理划分频段，使信道频带资源得到充分利用，只要频段划分合理且接收端能准确分离不同频段的信号，就可同时传输多个信号，提高系统并发处理能力。
- **波分多路复用方面**
  - **不同波长光信号并行传输**：在光纤通信中，利用不同波长的光信号在同一根光纤中传输。通过波分复用器将不同波长的光信号复合到一根光纤中，在接收端再通过波长分离器将不同波长的光信号分离出来。不同波长的光信号各自独立传输数据，实现多路光信号的并发传输，大大提高光纤传输容量，进而提高系统并发处理能力。例如一根光纤可同时传输多个不同波长的光信号，每个波长对应独立信道承载独立数据，实现大量数据并发传输。
- **码分多路复用方面**
  - **码序列区分并发信号**：每个用户使用唯一的码序列（扩频码）对自己的数据进行编码，不同用户的数据在同一信道上同时传输。在接收端，通过相关检测利用不同码序列的正交性分离出不同用户的数据。例如在CDMA移动通信系统中，多个用户可在同一频段上同时通信，基站通过识别不同用户的码序列来区分和接收他们的数据，实现多个用户数据的并发传输。
  - **提高频谱利用率**：多个用户可在同一频段上同时传输数据，无需像频分多路复用那样为每个用户分配独立频段，提高频谱资源利用率，在有限频谱资源下能够支持更多用户的并发通信，提高系统并发处理能力。
